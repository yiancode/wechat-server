# WeChat Server 部署指南

## 卸载与清理

### 清理 Docker 部署

如果之前使用 Docker 部署，需要先清理：

```bash
# 停止并删除容器
docker-compose down

# 删除镜像（可选）
docker rmi wechat-server

# 删除项目文件（可选）
cd /path/to/wechat-server
rm -rf wechat-server
```

### 清理 systemd 部署

如果之前使用 systemd 部署失败，需要清理：

```bash
# 停止服务
sudo systemctl stop wechat-server

# 禁用服务
sudo systemctl disable wechat-server

# 删除服务文件
sudo rm -f /etc/systemd/system/wechat-server.service

# 重载 systemd 配置
sudo systemctl daemon-reload

# 删除程序文件
sudo rm -rf /opt/wechat-server

# 验证清理完成
sudo systemctl status wechat-server  # 应该显示 "could not be found"
```

---

## 部署信息

| 项目 | 值 |
|------|-----|
| 域名 | `wx.example.com` |
| 端口 | 3000 |
| API Token | `your-api-token` |

## 一、服务器部署

### 方式一：Docker 部署（推荐）

1. **上传项目到服务器**

```bash
# 在服务器上克隆项目
git clone https://github.com/yiancode/wechat-server.git
cd wechat-server
```

2. **创建配置文件**

```bash
cat > config.yaml << 'EOF'
server:
  port: 3000
  api_token: "your-api-token"

accounts:
  - app_id: "your-app-id"
    app_secret: "your-app-secret"
    token: "your-wechat-token"
    name: "我的公众号"

code:
  length: 6
  expire_minutes: 5
EOF
```

3. **启动服务**

```bash
docker-compose up -d
```

4. **查看日志**

```bash
docker-compose logs -f
```

### 方式二：直接运行

```bash
# 编译
go build -o wechat-server

# 运行
./wechat-server
```

### 方式三：使用 systemd 管理（生产环境推荐）

#### 1. 克隆项目源码

**宝塔面板环境推荐**：

```bash
# 宝塔用户建议在网站根目录克隆项目
cd /www/wwwroot

# 克隆项目
git clone https://github.com/yiancode/wechat-server.git
cd wechat-server

# 或者，如果你已经通过宝塔的"远程下载"功能克隆了项目
# 项目可能在类似这样的路径：
# /www/wwwroot/wechat-server
# /www/wwwroot/你的域名/wechat-server
```

**非宝塔环境**：

```bash
# 选择一个合适的目录克隆项目
cd /opt  # 或 /home/用户名
git clone https://github.com/yiancode/wechat-server.git
cd wechat-server
```

**说明**：
- 宝塔面板默认网站目录：`/www/wwwroot/`
- 项目源码目录：存放源代码、编译项目的地方
- 程序运行目录：`/opt/wechat-server`（稍后创建）

#### 2. 准备程序运行目录

```bash
# 创建程序运行目录（用于存放编译后的可执行文件）
sudo mkdir -p /opt/wechat-server

# 确认当前在项目源码目录
pwd
# 宝塔环境应该显示：/www/wwwroot/wechat-server
# 其他环境可能是：/opt/wechat-server 或其他路径
```

#### 3. 编译可执行文件

```bash
# 编译 Go 程序
go build -o wechat-server

# 查看编译结果
ls -lh wechat-server
# 应该看到类似：-rwxr-xr-x 1 user user 10M Dec 12 01:00 wechat-server

# 验证可执行文件
file wechat-server
# 应该显示：wechat-server: ELF 64-bit LSB executable...
```

#### 4. 部署文件到目标目录

```bash
# 复制可执行文件到目标目录
sudo cp wechat-server /opt/wechat-server/

# 复制配置文件（如果有）
sudo cp config.yaml /opt/wechat-server/  # 如果你有配置文件

# 或者创建新的配置文件
sudo cat > /opt/wechat-server/config.yaml << 'EOF'
server:
  port: 3000
  api_token: "your-api-token"

accounts:
  - app_id: "your-app-id"
    app_secret: "your-app-secret"
    token: "your-wechat-token"
    name: "我的公众号"

code:
  length: 6
  expire_minutes: 5
EOF

# 设置执行权限（重要！）
sudo chmod +x /opt/wechat-server/wechat-server

# 验证文件部署
ls -lh /opt/wechat-server/
```

#### 5. 测试可执行文件

在创建服务之前，先测试程序是否能正常运行：

```bash
# 切换到程序目录
cd /opt/wechat-server

# 尝试直接运行
sudo ./wechat-server

# 如果程序正常启动，按 Ctrl+C 停止
# 如果报错，检查：
# - 配置文件是否正确
# - 端口是否被占用
# - 依赖库是否缺失（运行 ldd wechat-server 检查）
```

#### 6. 创建 systemd 服务文件

```bash
sudo cat > /etc/systemd/system/wechat-server.service << 'EOF'
[Unit]
Description=WeChat Server
After=network.target

[Service]
Type=simple
User=root
WorkingDirectory=/opt/wechat-server
ExecStart=/opt/wechat-server/wechat-server
Restart=always
RestartSec=5

# 环境变量（可选）
# Environment="ENV=production"

# 日志配置
StandardOutput=journal
StandardError=journal
SyslogIdentifier=wechat-server

[Install]
WantedBy=multi-user.target
EOF
```

#### 7. 启动和管理服务

```bash
# 重载 systemd 配置
sudo systemctl daemon-reload

# 启用开机自启
sudo systemctl enable wechat-server

# 启动服务
sudo systemctl start wechat-server

# 查看服务状态
sudo systemctl status wechat-server

# 应该看到：
# ● wechat-server.service - WeChat Server
#    Loaded: loaded (/etc/systemd/system/wechat-server.service; enabled)
#    Active: active (running) since...
```

#### 8. 查看日志

```bash
# 查看实时日志
sudo journalctl -u wechat-server -f

# 查看最近 50 条日志
sudo journalctl -u wechat-server -n 50

# 查看今天的日志
sudo journalctl -u wechat-server --since today

# 查看错误日志
sudo journalctl -u wechat-server -p err
```

#### 9. 常用管理命令

```bash
# 重启服务
sudo systemctl restart wechat-server

# 停止服务
sudo systemctl stop wechat-server

# 查看服务是否开机自启
sudo systemctl is-enabled wechat-server

# 禁用开机自启
sudo systemctl disable wechat-server

# 查看服务配置
sudo systemctl cat wechat-server
```

#### 10. 故障排查

**问题 1：状态显示 "status=203/EXEC"**

这表示可执行文件无法执行，检查：

```bash
# 1. 检查文件是否存在
ls -l /opt/wechat-server/wechat-server

# 2. 检查执行权限
# 应该显示：-rwxr-xr-x（包含 x 权限）
# 如果没有，运行：
sudo chmod +x /opt/wechat-server/wechat-server

# 3. 检查文件类型
file /opt/wechat-server/wechat-server
# 应该显示：ELF 64-bit LSB executable

# 4. 检查动态链接库依赖
ldd /opt/wechat-server/wechat-server
# 如果显示 "not found"，说明缺少依赖库

# 5. 尝试直接运行
cd /opt/wechat-server
sudo ./wechat-server
# 查看具体错误信息
```

**问题 2：服务启动后立即退出**

```bash
# 查看详细错误日志
sudo journalctl -u wechat-server -n 100 --no-pager

# 常见原因：
# - 配置文件格式错误
# - 端口被占用（检查：sudo netstat -tulpn | grep 3000）
# - 权限不足
```

**问题 3：端口被占用**

```bash
# 查看端口占用
sudo netstat -tulpn | grep 3000

# 或使用 lsof
sudo lsof -i :3000

# 如果需要更换端口，修改配置文件
sudo nano /opt/wechat-server/config.yaml
# 然后重启服务
sudo systemctl restart wechat-server
```

**问题 4：配置文件错误**

```bash
# 检查配置文件语法
cat /opt/wechat-server/config.yaml

# YAML 格式注意事项：
# - 使用空格缩进，不要用 Tab
# - 冒号后面要有空格
# - 字符串建议用引号包裹
```

#### 11. 更新程序

```bash
# 1. 停止服务
sudo systemctl stop wechat-server

# 2. 备份旧版本
sudo cp /opt/wechat-server/wechat-server /opt/wechat-server/wechat-server.bak

# 3. 进入项目源码目录并拉取最新代码
# 宝塔环境：
cd /www/wwwroot/wechat-server
# 非宝塔环境：
# cd /opt/wechat-server  # 或你的项目路径

git pull  # 拉取最新代码

# 4. 重新编译
go build -o wechat-server

# 5. 部署新版本
sudo cp wechat-server /opt/wechat-server/
sudo chmod +x /opt/wechat-server/wechat-server

# 6. 启动服务
sudo systemctl start wechat-server

# 7. 查看状态
sudo systemctl status wechat-server

# 如果新版本有问题，回滚：
sudo cp /opt/wechat-server/wechat-server.bak /opt/wechat-server/wechat-server
sudo systemctl restart wechat-server
```

---

## 二、Nginx 反向代理配置

### 申请 SSL 证书

```bash
# 使用 certbot 申请 Let's Encrypt 证书
sudo certbot certonly --nginx -d wx.example.com
```

### Nginx 配置

```nginx
# /etc/nginx/sites-available/wx.example.com
server {
    listen 80;
    server_name wx.example.com;
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name wx.example.com;

    ssl_certificate /etc/letsencrypt/live/wx.example.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/wx.example.com/privkey.pem;

    location / {
        proxy_pass http://127.0.0.1:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

### 启用配置

```bash
sudo ln -s /etc/nginx/sites-available/wx.example.com /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx
```

---

## 三、DNS 配置

在域名服务商处添加 A 记录：

| 类型 | 主机记录 | 记录值 |
|------|---------|--------|
| A | wx | 你的服务器IP |

---

## 四、微信公众平台配置

登录 [微信公众平台](https://mp.weixin.qq.com/) → 设置与开发 → 基本配置 → 服务器配置

| 配置项 | 值 |
|--------|-----|
| 服务器地址(URL) | `https://wx.example.com/wechat/{your-app-id}` |
| 令牌(Token) | `your-wechat-token` |
| 消息加解密方式 | 明文模式 |

**操作步骤**：
1. 点击"修改配置"
2. 填入上述信息
3. 点击"提交"验证
4. 验证成功后点击"启用"

---

## 五、Yi-API 后台配置

登录 Yi-API 管理后台 → 系统设置 → 配置 WeChat Server

| 配置项 | 值 |
|--------|-----|
| WeChat Server 服务器地址 | `https://wx.example.com` |
| WeChat Server 访问凭证 | `your-api-token` |
| 微信公众号二维码图片链接 | 你的公众号二维码图片 URL |

然后在 **配置登录注册** 中开启 **允许通过微信登录 & 注册**。

---

## 六、验证部署

### 1. 健康检查

```bash
curl https://wx.example.com/health
# 期望返回: {"status":"ok"}
```

### 2. 服务状态

```bash
curl https://wx.example.com/api/wechat/stats \
  -H "Authorization: your-api-token"
```

### 3. 微信验证

在微信公众平台提交服务器配置时会自动验证。

---

## 七、常见问题

### Q: 微信验证失败？

1. 检查服务是否运行：`curl https://wx.example.com/health`
2. 检查 Token 是否一致
3. 检查 URL 中的 app_id 是否正确
4. 检查 Nginx 配置和 SSL 证书

### Q: Yi-API 验证失败？

1. 检查 API Token 是否正确
2. 检查服务器地址是否包含协议 `https://`
3. 查看 WeChat Server 日志

### Q: 验证码获取失败？

1. 确认公众号服务器配置已"启用"
2. 检查 WeChat Server 日志
3. 确认用户已关注公众号
