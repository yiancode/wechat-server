# WeChat Server 部署指南

## 部署信息

| 项目 | 值 |
|------|-----|
| 域名 | `wx.example.com` |
| 端口 | 3000 |
| API Token | `your-api-token` |

## 一、服务器部署

### 方式一：Docker 部署（推荐）

1. **上传项目到服务器**

```bash
# 在服务器上克隆项目
git clone https://github.com/yiancode/wechat-server.git
cd wechat-server
```

2. **创建配置文件**

```bash
cat > config.yaml << 'EOF'
server:
  port: 3000
  api_token: "your-api-token"

accounts:
  - app_id: "your-app-id"
    app_secret: "your-app-secret"
    token: "your-wechat-token"
    name: "我的公众号"

code:
  length: 6
  expire_minutes: 5
EOF
```

3. **启动服务**

```bash
docker-compose up -d
```

4. **查看日志**

```bash
docker-compose logs -f
```

### 方式二：直接运行

```bash
# 编译
go build -o wechat-server

# 运行
./wechat-server
```

### 方式三：使用 systemd 管理

1. **创建服务文件**

```bash
sudo cat > /etc/systemd/system/wechat-server.service << 'EOF'
[Unit]
Description=WeChat Server
After=network.target

[Service]
Type=simple
User=root
WorkingDirectory=/opt/wechat-server
ExecStart=/opt/wechat-server/wechat-server
Restart=always
RestartSec=5

[Install]
WantedBy=multi-user.target
EOF
```

2. **启动服务**

```bash
sudo systemctl daemon-reload
sudo systemctl enable wechat-server
sudo systemctl start wechat-server
sudo systemctl status wechat-server
```

---

## 二、Nginx 反向代理配置

### 申请 SSL 证书

```bash
# 使用 certbot 申请 Let's Encrypt 证书
sudo certbot certonly --nginx -d wx.example.com
```

### Nginx 配置

```nginx
# /etc/nginx/sites-available/wx.example.com
server {
    listen 80;
    server_name wx.example.com;
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name wx.example.com;

    ssl_certificate /etc/letsencrypt/live/wx.example.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/wx.example.com/privkey.pem;

    location / {
        proxy_pass http://127.0.0.1:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

### 启用配置

```bash
sudo ln -s /etc/nginx/sites-available/wx.example.com /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx
```

---

## 三、DNS 配置

在域名服务商处添加 A 记录：

| 类型 | 主机记录 | 记录值 |
|------|---------|--------|
| A | wx | 你的服务器IP |

---

## 四、微信公众平台配置

登录 [微信公众平台](https://mp.weixin.qq.com/) → 设置与开发 → 基本配置 → 服务器配置

| 配置项 | 值 |
|--------|-----|
| 服务器地址(URL) | `https://wx.example.com/wechat/{your-app-id}` |
| 令牌(Token) | `your-wechat-token` |
| 消息加解密方式 | 明文模式 |

**操作步骤**：
1. 点击"修改配置"
2. 填入上述信息
3. 点击"提交"验证
4. 验证成功后点击"启用"

---

## 五、Yi-API 后台配置

登录 Yi-API 管理后台 → 系统设置 → 配置 WeChat Server

| 配置项 | 值 |
|--------|-----|
| WeChat Server 服务器地址 | `https://wx.example.com` |
| WeChat Server 访问凭证 | `your-api-token` |
| 微信公众号二维码图片链接 | 你的公众号二维码图片 URL |

然后在 **配置登录注册** 中开启 **允许通过微信登录 & 注册**。

---

## 六、验证部署

### 1. 健康检查

```bash
curl https://wx.example.com/health
# 期望返回: {"status":"ok"}
```

### 2. 服务状态

```bash
curl https://wx.example.com/api/wechat/stats \
  -H "Authorization: your-api-token"
```

### 3. 微信验证

在微信公众平台提交服务器配置时会自动验证。

---

## 七、常见问题

### Q: 微信验证失败？

1. 检查服务是否运行：`curl https://wx.example.com/health`
2. 检查 Token 是否一致
3. 检查 URL 中的 app_id 是否正确
4. 检查 Nginx 配置和 SSL 证书

### Q: Yi-API 验证失败？

1. 检查 API Token 是否正确
2. 检查服务器地址是否包含协议 `https://`
3. 查看 WeChat Server 日志

### Q: 验证码获取失败？

1. 确认公众号服务器配置已"启用"
2. 检查 WeChat Server 日志
3. 确认用户已关注公众号
